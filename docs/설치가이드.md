# 다중 동글 VPN 게이트웨이 설치 가이드

## 📌 시스템 개요

USB 동글 11~20개를 사용하여 다중 에이전트가 동시에 접속 가능한 VPN 게이트웨이 서버 구축 시스템입니다.

### 주요 특징
- **6개 독립 VPN 서버** (WireGuard 기반)
- **자동 부하 분산** (동글 간 트래픽 분산)
- **Kill Switch** (VPN 연결 실패 시 IP 보호)
- **동적 에이전트 관리** (자동 IP 할당 및 관리)
- **유연한 인증 시스템** (임시/영구/QR코드 접속)

---

## 🚀 빠른 시작

### 1단계: 시스템 요구사항
- Linux (RHEL/CentOS/Fedora 9)
- Python 3.9 이상
- 루트 권한
- USB 동글 11~20개
- 기가비트 이더넷 (권장)

### 2단계: 기본 패키지 설치
```bash
# 시스템 업데이트
sudo dnf update -y

# WireGuard 설치
sudo dnf install -y wireguard-tools

# Python 및 관련 패키지
sudo dnf install -y python3 python3-pip
pip3 install flask qrcode pillow

# 네트워크 도구
sudo dnf install -y NetworkManager iptables-services
```

### 3단계: VPN 서버 자동 설정
```bash
# 스크립트 실행 권한 부여
chmod +x scripts/multi_agent_vpn_setup.sh

# VPN 서버 6개 자동 생성
sudo bash scripts/multi_agent_vpn_setup.sh
```

---

## ⚙️ 상세 설정

### 1. IP 포워딩 활성화

```bash
# 영구 설정
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 2. VPN 인터페이스 구성

각 VPN 인터페이스는 독립적으로 작동합니다:

| 인터페이스 | 포트 | 서브넷 | 동글 라우팅 |
|-----------|------|--------|------------|
| wg0 | 51820 | 10.0.0.0/24 | 동글1 |
| wg1 | 51821 | 10.0.1.0/24 | 동글2 |
| wg2 | 51822 | 10.0.2.0/24 | 동글1 |
| wg3 | 51823 | 10.0.3.0/24 | 동글2 |
| wg4 | 51824 | 10.0.4.0/24 | 동글1 |
| wg5 | 51825 | 10.0.5.0/24 | 동글2 |

### 3. 라우팅 테이블 설정

```bash
# 각 VPN용 독립 라우팅 테이블
ip rule add from 10.0.0.0/24 lookup 200
ip route add default dev enp0s21f0u4 table 200

# NAT 설정
iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o enp0s21f0u4 -j MASQUERADE
```

### 4. Kill Switch 활성화

```bash
# Kill Switch 스크립트 실행
sudo bash scripts/vpn_killswitch.sh

# 규칙 확인
iptables -L -n -v
```

---

## 👥 클라이언트 연결

### 자동 클라이언트 생성

```python
# 에이전트 연결 관리자 실행
python3 src/agent_connection_manager.py

# 새 에이전트 추가 (Python 스크립트 내에서)
manager = AgentConnectionManager()
result = manager.assign_agent("agent_001", "에이전트1")
print(result['config'])
```

### 수동 클라이언트 설정

`/etc/wireguard/client.conf` 파일 생성:

```ini
[Interface]
PrivateKey = [생성된_개인키]
Address = 10.0.0.2/32
DNS = 8.8.8.8

[Peer]
PublicKey = [서버_공개키]
Endpoint = [서버_IP]:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
```

### 연결 명령어

```bash
# 클라이언트에서 실행
wg-quick up ./client.conf

# 연결 확인
curl ifconfig.me
```

---

## 🔧 관리 및 모니터링

### VPN 상태 확인

```bash
# 전체 인터페이스 상태
wg show

# 특정 인터페이스 상세
wg show wg0

# 연결된 피어 수
wg show all dump | grep peer | wc -l
```

### 트래픽 모니터링

```bash
# 실시간 대역폭
iftop -i enp0s21f0u4

# 인터페이스 통계
vnstat -l -i enp0s21f0u4

# 연결 로그
journalctl -u wg-quick@wg0 -f
```

### 에이전트 관리

```python
# Python으로 에이전트 모니터링
from agent_connection_manager import AgentConnectionManager

manager = AgentConnectionManager()
manager.monitor_agents()  # 전체 에이전트 상태 출력
manager.cleanup_inactive_agents()  # 비활성 에이전트 정리
```

---

## 🛡️ 보안 설정

### 방화벽 규칙

```bash
# VPN 포트 허용
firewall-cmd --permanent --add-port=51820-51825/udp
firewall-cmd --reload

# SSH는 유지하면서 다른 트래픽 차단
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -P INPUT DROP
```

### 인증 시스템 활성화

```python
# VPN 인증 관리자 실행
python3 src/vpn_auth_manager.py

# 임시 액세스 생성 (24시간)
manager.create_temp_access(duration_hours=24)

# QR 코드 생성
manager.generate_qr_access("사용자명")
```

---

## 📊 성능 최적화

### 대역폭 관리

100Mbps 이더넷 환경에서 20개 동글 사용 시:
- 각 동글당 5Mbps 제한 필요
- 기가비트 이더넷 업그레이드 권장

```bash
# QoS 설정 (동글당 5Mbps 제한)
tc qdisc add dev enp0s21f0u4 root handle 1: htb
tc class add dev enp0s21f0u4 parent 1: classid 1:1 htb rate 5mbit
```

### MTU 최적화

```bash
# WireGuard MTU 설정
wg set wg0 mtu 1420

# 시스템 MTU 확인
ip link show wg0
```

---

## 🔄 자동 시작 설정

```bash
# 각 VPN 인터페이스 자동 시작
for i in {0..5}; do
    sudo systemctl enable wg-quick@wg$i
done

# 상태 확인
systemctl status wg-quick@wg0
```

---

## ❗ 문제 해결

### 연결 실패 시

```bash
# 인터페이스 재시작
wg-quick down wg0
wg-quick up wg0

# 라우팅 테이블 확인
ip route show table 200

# NAT 규칙 확인
iptables -t nat -L POSTROUTING -n -v
```

### 동글 인식 문제

```bash
# USB 디바이스 확인
lsusb

# 네트워크 인터페이스 확인
ip link show | grep enp

# NetworkManager 재시작
systemctl restart NetworkManager
```

---

## 📝 설정 파일 위치

```
/etc/wireguard/         # WireGuard 설정
├── wg0.conf           # VPN 서버 0
├── wg1.conf           # VPN 서버 1
└── ...

/home/proxy/            # 관리 스크립트
├── scripts/           # 셸 스크립트
├── src/              # Python 코드
└── configs/          # 설정 템플릿
```

---

## 🎯 사용 예시

### 4-6개 에이전트 동시 접속

```javascript
// Playwright 예시
const agents = [];
for (let i = 0; i < 6; i++) {
    const agent = await connectToVPN(port: 51820 + i);
    agents.push(agent);
}

// 모든 에이전트가 다른 동글 IP 사용
agents.forEach(agent => {
    console.log(await agent.getIP());
});
```

---

## 📞 지원

문제 발생 시 다음을 확인하세요:
1. 모든 스크립트가 실행 권한이 있는지
2. IP 포워딩이 활성화되어 있는지
3. 방화벽이 VPN 포트를 허용하는지
4. 동글이 정상적으로 인터넷에 연결되어 있는지

---

**작성일**: 2024년
**버전**: 1.0
**라이선스**: MIT