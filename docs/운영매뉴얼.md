# VPN 게이트웨이 운영 매뉴얼

## 📋 일일 운영 체크리스트

### 아침 점검 (09:00)
- [ ] VPN 서비스 상태 확인
- [ ] 동글 연결 상태 확인
- [ ] 트래픽 사용량 확인
- [ ] 에러 로그 확인

### 저녁 점검 (18:00)
- [ ] 비활성 에이전트 정리
- [ ] 로그 백업
- [ ] 성능 지표 기록

---

## 🔍 모니터링 명령어

### 1. 서비스 상태 확인

```bash
# VPN 서비스 전체 상태
for i in {0..5}; do
    echo "=== wg$i 상태 ==="
    systemctl status wg-quick@wg$i --no-pager | grep Active
done

# 활성 연결 수
echo "총 연결된 피어: $(wg show all dump | grep -c peer)"
```

### 2. 동글 상태 확인

```bash
# 동글 인터페이스 확인
#!/bin/bash
dongles=("enp0s21f0u4" "enp0s21f0u3")
for dongle in "${dongles[@]}"; do
    if ip link show $dongle &>/dev/null; then
        echo "✅ $dongle: 연결됨"
        ip addr show $dongle | grep "inet "
    else
        echo "❌ $dongle: 연결 안됨"
    fi
done
```

### 3. 트래픽 모니터링

```bash
# 실시간 트래픽 (종료: q)
watch -n 1 'wg show all transfer'

# 인터페이스별 대역폭 사용량
for i in {0..5}; do
    echo "wg$i 트래픽:"
    wg show wg$i transfer
done
```

---

## 🛠️ 유지보수 작업

### 에이전트 관리

#### 새 에이전트 추가
```python
#!/usr/bin/env python3
from agent_connection_manager import AgentConnectionManager

manager = AgentConnectionManager()

# 새 에이전트 등록
agent_id = "agent_20240101"
agent_name = "테스트에이전트"
result = manager.assign_agent(agent_id, agent_name)

print(f"에이전트 설정:\n{result['config']}")
print(f"할당된 IP: {result['connection_info']['ip']}")
print(f"연결 포트: {result['connection_info']['port']}")
```

#### 비활성 에이전트 정리
```python
# 30분 이상 비활성 에이전트 자동 제거
manager.cleanup_inactive_agents(threshold_minutes=30)
```

#### 에이전트 상태 조회
```python
# 전체 에이전트 모니터링
manager.monitor_agents()

# 특정 에이전트 상태
status = manager.get_agent_status("agent_id")
if status:
    print(f"상태: {status['status']}")
    print(f"트래픽: RX={status['traffic']['rx']} TX={status['traffic']['tx']}")
```

### 동글 IP 변경

```bash
# 동글 재연결 (IP 변경)
#!/bin/bash
dongle_interface="enp0s21f0u4"

echo "동글 IP 변경 중..."
sudo nmcli device disconnect $dongle_interface
sleep 5
sudo nmcli device connect $dongle_interface

# 새 IP 확인
new_ip=$(ip addr show $dongle_interface | grep "inet " | awk '{print $2}')
echo "새 IP: $new_ip"
```

### 로그 관리

```bash
# 로그 위치
/var/log/wireguard/     # WireGuard 로그
/home/proxy/logs/       # 애플리케이션 로그

# 로그 순환 설정 (/etc/logrotate.d/wireguard)
/var/log/wireguard/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}

# 수동 로그 백업
tar -czf vpn_logs_$(date +%Y%m%d).tar.gz /var/log/wireguard/
```

---

## 🚨 장애 대응

### Case 1: VPN 연결 불가

**증상**: 클라이언트가 VPN에 연결되지 않음

**해결 절차**:
```bash
# 1. 서비스 상태 확인
systemctl status wg-quick@wg0

# 2. 포트 리스닝 확인
netstat -ulnp | grep 51820

# 3. 방화벽 확인
iptables -L INPUT -n -v | grep 51820

# 4. 인터페이스 재시작
wg-quick down wg0
wg-quick up wg0

# 5. 로그 확인
journalctl -xe -u wg-quick@wg0
```

### Case 2: 트래픽이 동글로 나가지 않음

**증상**: VPN 연결은 되지만 외부 IP가 서버 IP로 표시

**해결 절차**:
```bash
# 1. 라우팅 테이블 확인
ip rule show
ip route show table 200

# 2. NAT 규칙 확인
iptables -t nat -L POSTROUTING -n -v

# 3. 라우팅 재설정
ip rule add from 10.0.0.0/24 lookup 200
ip route add default dev enp0s21f0u4 table 200

# 4. NAT 재설정
iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o enp0s21f0u4 -j MASQUERADE
```

### Case 3: 동글 연결 끊김

**증상**: 동글 인터페이스가 사라짐

**해결 절차**:
```bash
# 1. USB 상태 확인
lsusb | grep -i modem

# 2. NetworkManager 재시작
systemctl restart NetworkManager

# 3. 수동 연결
nmcli device connect enp0s21f0u4

# 4. 자동 복구 스크립트 실행
bash scripts/dongle_failover.sh
```

---

## 📊 성능 모니터링

### 실시간 대시보드

```python
#!/usr/bin/env python3
import time
import subprocess
from datetime import datetime

def get_vpn_stats():
    """VPN 통계 수집"""
    stats = {}
    for i in range(6):
        result = subprocess.run(
            f"wg show wg{i} dump", 
            shell=True, 
            capture_output=True, 
            text=True
        )
        peers = len(result.stdout.strip().split('\n')) - 1
        stats[f'wg{i}'] = peers
    return stats

def monitor_dashboard():
    """실시간 모니터링 대시보드"""
    while True:
        os.system('clear')
        print(f"=== VPN 게이트웨이 모니터링 === {datetime.now()}")
        print()
        
        stats = get_vpn_stats()
        total_peers = sum(stats.values())
        
        for vpn, peers in stats.items():
            bar = '█' * peers + '░' * (10 - peers)
            print(f"{vpn}: [{bar}] {peers} 피어")
        
        print(f"\n총 연결: {total_peers} / 60")
        print("\nCtrl+C로 종료")
        
        time.sleep(5)

if __name__ == "__main__":
    monitor_dashboard()
```

### 일일 리포트 생성

```bash
#!/bin/bash
# daily_report.sh

DATE=$(date +%Y-%m-%d)
REPORT_FILE="/home/proxy/reports/daily_$DATE.txt"

echo "=== VPN 일일 리포트 $DATE ===" > $REPORT_FILE
echo "" >> $REPORT_FILE

# 서비스 가동률
echo "## 서비스 상태" >> $REPORT_FILE
for i in {0..5}; do
    status=$(systemctl is-active wg-quick@wg$i)
    echo "wg$i: $status" >> $REPORT_FILE
done

# 트래픽 통계
echo -e "\n## 트래픽 통계" >> $REPORT_FILE
wg show all transfer >> $REPORT_FILE

# 에러 로그
echo -e "\n## 에러 로그 (최근 24시간)" >> $REPORT_FILE
journalctl --since="24 hours ago" -p err >> $REPORT_FILE

echo "리포트 생성 완료: $REPORT_FILE"
```

---

## 🔐 보안 점검

### 주간 보안 체크리스트

- [ ] 비인가 접속 시도 확인
- [ ] 비정상 트래픽 패턴 확인
- [ ] 시스템 업데이트 확인
- [ ] 백업 상태 확인

### 보안 로그 확인

```bash
# 실패한 연결 시도
grep "Failed" /var/log/wireguard/*.log

# 비정상 패킷
tcpdump -i wg0 -c 100 'tcp[tcpflags] & (tcp-syn) != 0'

# 연결 IP 목록
wg show all endpoints | awk '{print $2}' | cut -d: -f1 | sort -u
```

---

## 💾 백업 및 복구

### 설정 백업

```bash
#!/bin/bash
# backup_vpn.sh

BACKUP_DIR="/home/proxy/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/vpn_backup_$DATE.tar.gz"

# 백업 디렉토리 생성
mkdir -p $BACKUP_DIR

# 설정 파일 백업
tar -czf $BACKUP_FILE \
    /etc/wireguard/ \
    /home/proxy/scripts/ \
    /home/proxy/src/ \
    /home/proxy/configs/

echo "백업 완료: $BACKUP_FILE"

# 7일 이상 된 백업 삭제
find $BACKUP_DIR -name "vpn_backup_*.tar.gz" -mtime +7 -delete
```

### 복구 절차

```bash
# 백업에서 복구
tar -xzf vpn_backup_20240101_120000.tar.gz -C /

# 서비스 재시작
for i in {0..5}; do
    systemctl restart wg-quick@wg$i
done

# 상태 확인
wg show
```

---

## 📈 확장 계획

### 동글 추가 시

1. 새 동글 인터페이스 확인
```bash
ip link show | grep enp
```

2. 라우팅 테이블 추가
```bash
echo "210 dongle3" >> /etc/iproute2/rt_tables
```

3. VPN 설정 수정
```bash
# wg6.conf 생성
# 라우팅 테이블 210 사용
```

### 성능 업그레이드

- 100Mbps → 1Gbps 이더넷
- USB 2.0 → USB 3.0 허브
- 더 많은 CPU 코어

---

## 📝 운영 팁

1. **정기 재부팅**: 주 1회 새벽 시간대
2. **로그 정리**: 매일 자정 자동 실행
3. **모니터링**: 5분 간격 상태 체크
4. **백업**: 일일 자동, 주간 수동
5. **문서화**: 모든 변경사항 기록

---

**최종 업데이트**: 2024년
**담당자**: 시스템 관리팀
**비상 연락처**: 내부 문서 참조